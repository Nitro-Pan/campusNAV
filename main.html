<!DOCTYPE html>
<html lang="en">

<head>
  <title>Main Page</title>
  <meta charset="utf-8" />
  <link type='text/css' rel='stylesheet' href='style2.css' />

  <!------------------------------------------------------------------------------>
  <!-- Bootstrap for Mobile-first                                               -->
  <!------------------------------------------------------------------------------>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <!------------------------------------------------------------------------------>
  <!-- Add Firebase products that you want to use                               -->
  <!------------------------------------------------------------------------------>
  <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-firestore.js"></script>
  <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />

  <style>
    body {
      background-image: url(./tempmapbg.png);
      background-size: 100vw 100vh;
    }

    #menuButton {
      display: block;
      width: 20vw;
      height: 20vw;
      position: fixed;
      bottom: 5%;
      left: 40%;
      border-radius: 50%;
      z-index: 10;
    }

    #menu {
      display: block;
      height: 80vh;
      width: 100vw;
      position: fixed;
      background-color: rgba(67, 67, 67, 0.6);
      z-index: 0;
      color: white;
      text-align: left;
      transition-duration: 200ms;
      transition-timing-function: cubic-bezier(0.47, 0, 0.745, 0.715);
    }

    #menu>* {
      margin-left: 8px;
      font-size: 1.3em;
    }

    .menuUp {
      bottom: 0;
    }

    .menuDown {
      bottom: -100%;
    }

    #locationSearch {
      margin-top: 30px;
    }

    #locationInput {
      width: 60vw;
    }

    #searchClick {
      width: 20%;
      border-style: solid;
      border-width: 1px;
      border-radius: 5%;
      display: none;
      margin: 0 auto;
      background: white;
    }
  </style>
</head>

<body>
  <span id='locationDot'
    style='position: fixed; background-color: red; width: 20px; height: 20px; border-radius: 50%; top: 0px;'></span>

  <div id="locationSearch">
    <input id="locationInput" type="text" placeholder="Search for Building">
    <div id="searchClick">Search</div>
  </div>

  <div id='menuButton'><img src="menu_button.png" width="100%" height="100%"></div>
  <div id='menu' class='menuDown'>
    <div>Hello, <span id="userName">User!</span></div>
    <div id='debug' style='display: none;'>
      <p id='latlongdebug'>lat/long</p>
      <p id='bcitsize'>size</p>
      <p id='relbcitloc'>relative location</p>
      <p id='relbcitlocpercent'>percentage location</p>
    </div>
    <p id='logout'>Logout</p>
    <p id='debugShow'>Show Debug Info</p>
  </div>
</body>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCk0i8nhu1vqh0c9dUIUEGy_2jNq6i4Glw",
    authDomain: "campus-nav-8edaf.firebaseapp.com",
    databaseURL: "https://campus-nav-8edaf.firebaseio.com",
    projectId: "campus-nav-8edaf",
    storageBucket: "campus-nav-8edaf.appspot.com",
    messagingSenderId: "926858289313",
    appId: "1:926858289313:web:7171d305abb80d1a60d0e0"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();
</script>

<script>
  var userID;
  $(document).ready(function () {
    let menuIsDown = true;
    $("#menuButton").click(function () {
      $("#menu").toggleClass("menuUp");
      $("#menu").toggleClass("menuDown");

      if (menuIsDown) {
        $("#menuButton img").attr("src", "close_button.png");
        menuIsDown = false;
      } else {
        $("#menuButton img").attr("src", "menu_button.png");
        menuIsDown = true;
      }
    });

    $("#logout").click(function () {
      firebase.auth().signOut().then(function () {
        window.location = "index.html";
      }, function (e) {
        console.log("You can't sign out.");
      });
    });

    let debugIsShown = false;
    $("#debugShow").click(function () {
      if (debugIsShown) {
        $("#debug").css({ "display": "none" });
        $("#debugShow").text("Show Debug Info");
        debugIsShown = false;
      } else {
        $("#debug").css({ "display": "block" });
        $("#debugShow").text("Hide Debug Info");
        debugIsShown = true;
      }
    });

    $("#locationInput").focus(function (e) {
      $("#searchClick").css({ display: "block" });
    });
    $("#locationInput").blur(function (e) {
      sleep(1);
      $("#searchClick").css({ display: "none" });
    });
    $("#locationInput").keydown(function (e) {
      let keycode = (e.keyCode ? e.keyCode : e.which);
      if (keycode == 13) {
        let input = $("#locationInput");
        if (userID && (input.val() != "")) {
          console.log("setting location");
          db.collection("users").doc(userID).collection("history").doc(input.val()).set({
            location: input.val()
          }).then(console.log("Updated location"));
        } else {
          console.log("Not logged in or no input");
        }
      }
    });
    $("#searchClick").click(function (e) {
      let input = $("#locationInput");
      if (userID) {
        db.collection("users").doc(userID).collection("history").doc(input.val()).add({
          location: input.val()
        });
      } else {
        console.log("Not logged in");
      }
    });

    // if time allows it, make the background scrollable. Don't worry about it for now.
    // let pos1 = 0;
    // let pos2 = 0;
    // let pos3 = 0;
    // let pos4 = 0;
    // let oldPositionX = 0;
    // let oldPositionY = 0;
    // let scrollingMap = false;
    // $("#mapScroll").mousedown(function (e) {
    //   scrollingMap = true;
    //   pos3 = e.pageX;
    //   pos4 = e.pageY;
    // });
    // $("#mapScroll").mouseup(function (e) {
    //   scrollingMap = false;
    //   pos3 = e.pageX;
    //   pos4 = e.pageY;
    // });
    // $("#mapScroll").mouseleave(function (e) {
    //   scrollingMap = false;
    //   pos3 = e.pageX;
    //   pos4 = e.pageY;
    // });
    // $("#mapScroll").mousemove(function (e) {
    //   if (scrollingMap) {
    //     pos1 = e.pageX - pos3;
    //     pos2 = e.pageY - pos4;
    //     // pos3 = e.pageX;
    //     // pos4 = e.pageY;

    //     $("#mapScroll").css({ transform: "translate(" + pos1 + "px," + pos2 + "px)" });
    //   }
    // });
  });

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(showPosition);
    } else {
      document.getElementById("latlongdebug").innerHTML = "No Geolocation :(";
    }
  }

  function showPosition(position) {
    console.log("Updated Position");

    document.getElementById("latlongdebug").innerHTML = "Lat: " + position.coords.latitude
      + "<br />Long: " + position.coords.longitude;

    var bcitLeft = -123.004656;
    var bcitRight = -122.998273;
    var bcitTop = 49.254732;
    var bcitBottom = 49.242950;

    var xWidth = bcitRight - bcitLeft;
    var yHeight = bcitTop - bcitBottom;

    var relLat = bcitTop - position.coords.latitude;
    var relLong = bcitRight - position.coords.longitude;

    var latPercent = (relLat / xWidth) * 100;
    var longPercent = (relLat / yHeight) * 100;

    document.getElementById("bcitsize").innerHTML = "BCIT width: " + xWidth + "<br />BCIT height: " + yHeight;
    document.getElementById("relbcitloc").innerHTML = "Relative width: " + relLat + "<br />Relative height: " + relLong;
    document.getElementById("relbcitlocpercent").innerHTML = "% width: " + (100 - latPercent) + "<br />% height: " + longPercent;

    var pos = document.getElementById("locationDot");
    pos.style.transform = "translate(" + (100 - latPercent) + "vw, " + longPercent + "vh)";
  }
  firebase.auth().onAuthStateChanged(function () {
    var user = firebase.auth().currentUser;
    //when user logs in, writes user name and email in Firestore
    if (user) {
      let userdb = db.collection("users");
      userID = user.uid;

      userdb.doc(user.uid).set({
        name: user.displayName,
        email: user.email
      });

      db.collection("users").doc(userID).get().then(function (doc) {
        document.getElementById("userName").innerHTML = doc.data().name;
      });
    } else {
      console.log("No user logged in");
    }
    //reads user current location stored in Firestore
  });

  //read: .get() , .onSnapshot()
  //write: .set() , .update() , .create() , .add()  

  //write: search history and read: search history when user clicks on searchbar
  //data-entry: building locations and read: building coordinates when user selects building


  getLocation();
</script>

</html>